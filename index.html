<!DOCTYPE html>
<html class="deployment-type-development">
  <head>
    <meta charset="utf-8">
    <base target="_blank">

    <title>Thimble Badge Integration Prototype</title>
    <link rel="stylesheet" href="css/friendlycode.css">
    <link rel="stylesheet" href="css/persona-button.css">
    <link rel="stylesheet" href="css/achievement.css">
    <link rel="stylesheet" href="css/badge.css">
    <link rel="stylesheet" href="css/media-object.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <style>
    html:not(.logged-out) .logged-out {
      display: none;
    }

    html:not(.logged-in) .logged-in {
      display: none;
    }
    
    #fc {
      position: absolute;
      top: 100px;
      left: 0;
      right: 0;
      bottom: 0;
      border-top: 1px solid gray;
      -moz-box-sizing: border-box;
    }

    header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100px;
      -moz-box-sizing: border-box;
      background: #f0f0f0;
      padding: 30px;
    }
    
    .btn.badge-button, .btn.badge-button:hover {
      background-image: url(img/badge.png);
      background-position: 2px 2px;
      background-size: 24px 24px;
      background-repeat: no-repeat;
      padding-left: 18px;
      min-height: 18px;
    }

    .btn.badge-button .unread-badges {
      margin-left: 10px;
    }
    
    /* Fix some blatant bootstrap-achievement CSS conflicts. */
    body .achievement {
      line-height: normal;
    }
    
    /* Fix some blatant bootstrap-persona CSS conficts. */    
    a.persona-button:hover {
      color: white;
    }
    
    /* Fix some blatant bootstrap-friendlycode CSS conflicts. */
    .hints-nav-item .checkbox {
      min-height: 0;
      padding-left: 0;
    }
    </style>
  </head>
  <body style="margin: 0">
    <header>
      <a href="#" class="persona-button logged-out"><span>Sign in
          with Persona</span></a>
      <div class="btn-toolbar logged-in">
        <div class="btn-group">
          <a class="btn btn-primary dropdown-toggle"
             data-toggle="dropdown" href="#">
            <span class="email"></span>
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            <li><a id="logout" href="#">Logout</a></li>
          </ul>
        </div>
        <div class="btn-group">
          <a class="btn badge-button" href="#badge-list" data-toggle="modal"><span class="badge unread-badges"></span></a>
        </div>
      </div>
    </header>
    <div id="badge-list" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Your Badges</h3>
      </div>
      <div class="modal-body">
        <div class="no-badges">
          <p>You don’t have any badges yet. Keep writing HTML and you’ll
            get some!</p>
        </div>
        <ul class="badges"></ul>
      </div>
      <div class="modal-footer some-badges">
        <button class="btn" id="push-to-backpack">Push 
          to backpack&hellip;</button>
      </div>
    </div>
    <div id="fc" class="friendlycode-loading"></div>
    <script src="js/require-config.js"></script>
    <script>
    require.shim.bootstrap = {
      deps: ["jquery"],
      exports: 'jQuery'
    };
    require.paths.bootstrap = "../bootstrap/js/bootstrap.min";
    </script>
    <script src="js/require.min.js"></script>
    <script>
    define("main", function(require) {
      var $ = require("bootstrap");
      var badgeTemplate = require("template!badge");
      var achievementTemplate = require("template!achievement");
      var FriendlycodeEditor = require("friendlycode");
      var Gapingbadger = require("badges/gapingbadger");
      var getWikiBadges = require("badges/get-wiki-badges");
      var badger = Gapingbadger("http://labs.toolness.com:3031");
      var wikiBadges = {};
      var wikiReq = $.Deferred();
      var userBadgesReq = $.Deferred();
      var readyToAwardBadges = $.when(wikiReq, userBadgesReq);
      var fc = FriendlycodeEditor({
        publishURL: "https://webpagemaker-dev.allizom.org",
        container: $("#fc")
      });

      /* Scrape available badges from the Mozilla wiki. */

      getWikiBadges('/Webmakers/SampleBadges', function(badges) {
        $.extend(wikiBadges, badges);
        wikiReq.resolve();
      });

      /* Manage BrowserID-based authentication semantics. */

      badger.checkLogin({
        success: function() {
          $("html").removeClass("logged-out").addClass("logged-in");
          $(".email").text(badger.email);
          badger.fetch(function(err) {
            if (!err)
              userBadgesReq.resolve();
          });
        },
        authenticate: function(next) {
          require(["https://login.persona.org/include.js"], function() {
            $("html").addClass("logged-out");
            $(".persona-button").unbind().click(function() {
              navigator.id.get(next);
              return false;
            });
          });
        }
      });

      $("#logout").click(function() {
        badger.logout();
        window.location.reload();
        return false;
      });

      $("#push-to-backpack").click(function() {
        require(["http://beta.openbadges.org/issuer.js"], function() {
          OpenBadges.issue(badger.getAssertionURLs());
        });
        return false;
      });
      
      $("#badge-list").on('shown', function() {
        /* The user is looking at their badge list, so reset the unread
         * badge count. */
         
        badger.markAllBadgesRead();
      });

      badger.on('award', function(badge) {
        /* The user has just been awarded a badge! Show a
         * Steam-like achievement popup. */

        var div = $(achievementTemplate(badge.badge));
        div.appendTo("html").hide().slideDown().delay(2000)
          .slideUp(function() { div.remove(); });
      });

      badger.on('change:badges', function() {
        /* One or more badges have been added or removed from the user's
         * account. Refresh the list. */
        
        var badgeList = $("#badge-list ul.badges");
        $(".no-badges").toggle(!badger.badges.length);
        $(".some-badges").toggle(!!badger.badges.length);
        badgeList.empty();
        badger.badges.forEach(function(badge) {
          var li = $(badgeTemplate(badge.badge));
          li.appendTo(badgeList);
        });
      });
      
      badger.on('change:unreadBadges', function() {
        /* The number of badges that the user hasn't "read" yet has
         * changed, so update the page accordingly. */

         if (badger.unreadBadges)
           $(".unread-badges").text(badger.unreadBadges.toString()).show();
         else
           $(".unread-badges").hide();
      });
      
      /* Manually trigger badger events to set up the initial page state. */

      badger.trigger('change:badges');
      badger.trigger('change:unreadBadges');

      readyToAwardBadges.done(function() {
        badger.awardUnique(wikiBadges.FIRST_LOGIN_BADGE);
      });
      
      return {
        fc: fc,
        badger: badger,
        wikiBadges: wikiBadges
      };
    });
    
    require(["main"], function(main) {
      /* For console debugging only! */
      window._app = main;
    });
    </script>
  </body>
</html>
