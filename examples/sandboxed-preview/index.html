<!DOCTYPE html>
<html class="deployment-type-development">
  <head>
    <meta charset="utf-8">
    <base target="_blank">

    <title>Sandboxed Preview Frame Friendlycode Editor</title>
    <link rel="stylesheet" href="../../css/friendlycode.css">
  </head>
  <body style="margin: 0">
    <div id="bare-fc-holder" class="friendlycode-loading"></div>

    <script src="../../js/require-config.js"></script>
    <script src="../../vendor/require.min.js"></script>
    <script>
    "use strict";

    // An editor-side live preview proxy that communicates with a
    // "real" live preview hosted (preferably) on a separate origin, to
    // prevent malicious user JavaScript from corrupting the editor
    // state.
    //
    // Note that this is only a proof-of-concept and is not yet production
    // code that has been through any kind of security review.
    define("fc/ui/live-preview-proxy", function(require) {
      var $ = require("jquery"),
          BackboneEvents = require("backbone-events"),
          Channel = require("jschannel");

      return function EditorSideLivePreview(options) {
        var self = {codeMirror: options.codeMirror, title: ""},
            codeMirror = options.codeMirror,
            readyToSendLatestReparse = false,
            iframeSandbox,
            channel,
            latestReparse;

        var sendLatestReparse = function() {
          channel.call({
            method: "setHTML",
            params: {
              error: latestReparse.error,
              sourceCode: latestReparse.sourceCode
            },
            error: function(name, msg) {
              if (window.console)
                window.console.log("setHTML() error", name, msg);
              readyToSendLatestReparse = true;
            },
            success: function(v) {
              readyToSendLatestReparse = true;
            }
          });
        };

        BackboneEvents.mixin(self);
        
        codeMirror.on("reparse", function(event) {
          var isPreviewInDocument = $.contains(document.documentElement,
                                               options.previewArea[0]);
          if (!isPreviewInDocument) {
            if (window.console)
              window.console.log("reparse triggered, but preview area is " +
                                 "not attached to the document.");
            return;
          }
          latestReparse = event;
          if (readyToSendLatestReparse)
            sendLatestReparse();
        });

        iframeSandbox = document.createElement("iframe");
        iframeSandbox.setAttribute("src", options.previewFrameURL);
        options.previewArea.append(iframeSandbox);
        channel = Channel.build({
          window: iframeSandbox.contentWindow,
          origin: "*",
          scope: "friendlycode"
        });
        channel.bind("change:title", function(trans, title) {
          self.trigger("change:title", title);
        });
        self.channelToPreview = channel;
        
        if (!options.plugins) options.plugins = [];
        options.plugins.forEach(function(plugin) {
          plugin.initEditorSide(self, self.channelToPreview);
        });
        
        channel.call({
          method: "init",
          params: {
            plugins: options.plugins.map(function(plugin) {
              return plugin.id;
            })
          },
          error: function(name, msg) {
            if (window.console)
              window.console.log("init error", name, msg);
          },
          success: sendLatestReparse
        });
        
        return self;
      };
    });
    
    require(["jquery", "friendlycode"], function($, FriendlycodeEditor) {
      return FriendlycodeEditor({
        publishURL: "https://webpagemaker-dev.allizom.org",
        previewFrameURL: "preview.html",
        container: $("#bare-fc-holder")
      });
    });
    </script>
  </body>
</html>
